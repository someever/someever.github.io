---
layout: post
title: 读书笔记-架构及未来
category: 架构
tags: 架构 书
---
现代企业可扩展的Web架构、流程和组织

# 可扩展性组织的人员配置

## 人、组织、管理、领导

- 冲突
    - 认知型冲突：好的冲突，健康的争辩，是团队关于该做什么或者为什么要做而发生的冲突，博采众长，头脑风暴
    - 情感型冲突：坏的冲突，基于角色，经常涉及怎么做或者该谁做
- 人：可扩展性的拼图中人员是最重要的一块
- 组织：对可扩展的组织，需要有合适的人，在合适的时间，以合适的行为，做合适的工作
    - 组织的结构很少有对错之分，任何结构都有利有弊
- 管理：管理是和实现目标相关的，缺乏管理可扩展性注定失败
- 领导：领导是和确定目标、描绘愿景、定义使命相关，缺乏领导对达成可扩展性目标不利
- 避免责任不清：组织角色定义清晰，
    - 责任重叠会造成资源浪费和价值损毁的冲突
    - 无人责任形成真空地带无法完成扩展的任务
- RASCI
    - R:responsible，负责
    - A：Accountable，批准
    - S：Supportive，支持
    - C：Consulted，咨询
    - I：Informed，知情

## 组织
- 团队的规模和组织结构是组织的两大关键属性
    - 太小的团队没有足够的能力来满足业务发展的需要
    - 太大的团队会造成生产率的下降和士气的低落
- 事项检查表
    - 最佳团队规模事项检查表
        - 确定经理的经验水平
        - 计算每个工程师在公司的工作年限
        - 询问每个工程师在行业内的工作年限
        - 根据经理的责任估计其总工作量
            - 调查经理在不同任务上花多少时间
            - 列出你期望经理完成的核心管理职能
        - 寻找因团队规模太小而无法发挥作用，所以心存不满的业务伙伴和经理
        - 发现因团队规模太大而造成的生产效率低下、沟通不畅和士气低落的迹象
    - 团队拆分事项检查表
        - 确定如何拆分代码
            - 按照服务拆分
            - 尽可能把基类平均分割
            - 在代码库中加入提醒，确保当相关代码被修改时每个人都知晓
        - 确定新的经理
            - 考虑内选还是外聘
            - 设定一个紧迫的时间来完成决策
        - 分析团队和其他部门之间的相互关系
            - 与其他部门负责人讨论团队拆分计划
            - 协调本团队的拆分与其他团队之间的关系，确保平滑过渡
            - 通过联合通知的方式同时向全体员工公布消息
- 组织结构
    - 职能型组织
        - 好处是经理和伙伴们的同质性，责任简单清晰，容易分配任务和很好的遵循标准
        - 坏处有没有单一的项目负责人和沟通不畅，甩锅、推卸责任（情感冲突）等
    - 矩阵型组织
        - 解决了一些职能型团队的弊端，负责人明确，跨部门沟通有所解决
        - 也引发了其他问题，多个老板和个人精力分散的问题。向两个或多个人汇报，收到多个老板的指令带来的压力
    - 敏捷型组织
        - 优势是提升了团队的创造力
        - 劣势是会有重叠，通用的服务、能力造成浪费，通过开源项目的方式能解决部分

## 领导力：影响一个组织或者个人达成某个特定目标的行为的力量
- 自知之明
- 以身作则
- 谦虚谨慎
- 大公无私
- 以人为本，使命为先
- 决策英明，以德服人
- 用人不疑
- 愿景
    - 对理想未来的生动描述
    - 为股东创造价值很重要
    - 可度量
    - 激动人心
    - 结合信仰的元素
    - 大致不变，可根据需要修改
    - 容易记忆
- 使命
    - 对当前状态和行动的描述
    - 有目的感
    - 可度量
    - 一个大方向或一条通往愿景的道路
- 目标
    - 具体
    - 可度量
    - 可达成（有挑战性）
    - 现实性
    - 时限性

## 管理：管理是以执法和道德手段来完成某件事
- 同领导一样，管理可以看做是一个由个性、能力、经验、行为和方法为参数组成的函数，
- 项目管理和任务管理是成功管理的关键
- 项目管理用5%的时间制定详细的计划，用95%的时间做好应付突发时间的准备。
- 人和组织管理活动被分解为：播种、施肥、除草
- 不度量就不能提高
- 目标树可以有效的把组织与公司的目标匹配，并帮助创建“通往成功的因果路线图”
- 管理者为成功铺路

## 关系、思维
- 技术缺乏业务思维，业务缺乏技术思维，有巨大的鸿沟
- 技术人员必须跨越鸿沟，进入业务领域，让业务主管能理解
- 计算中断和宕机时间的代价，能证明扩展支持人员是有必要的，也像团队证明高性能、高可用、高质量都是有必要的
- 一般技术分两种，一种是降本增效（为业务做各种工具），还有一种是盈利（直接产出技术产品面向客户盈利）

# 可扩展的过程
## 过程
- 助力团队和员工的管理，规范员工执行重复性任务时的行为，把员工从日常琐事中解放出来，专注于更大和更多的创意
- 确定最佳过程的方法
    - 从小到大的周期迭代
    - 让团队决定
- 过程和组织之间配合不好可能导致文化冲突或官僚主义
- 过程维护是保证组织规模与过程匹配的关键

## 管理事故和问题
- 事故是生产环境的问题。事故管理聚焦在及时有效的恢复生产服务的过程
- 问题是事故的原因。问题管理聚焦在确定问题的根源和解决问题的过程
- 时间管理可以浓缩为DRIER，它代表检测、报告、调查、升级、解决
- 事故管理和问题管理有天然的冲突，快速恢复服务会影响一些取证数据，影响问题调查，需要仔细思考权衡
- 每日事故例会、季度事故总结、事后头脑风暴

## 危机管理和升级
- 危机犹如类固醇，既可以使公司更强大，也可以破坏业务
- 要尽快和有效的解决危机，必须采取某些措施来控制混乱
- 危机处理小组由危机管理者、工程经理和高级工程师组成
- 危机管理团队成员应该在作战室面对面沟通，实在不可能应该用电话会议或者聊天室
- 在危机管理过程中要清楚的定义升级和情况通报

## 生产环境的变更管理
- 变更管理的目的是通过控制生产发布和记录活动，限制变更的影响
- 变更管理包括一下几个阶段：请求、审批、调度、执行和记录、验证、回顾
- 要能回滚

## 确定应用发展的预留空间
- 掌握各个组件的预留空间，做预算、制定招聘方案、确定发布计划、调整可扩展性项目的优先级
- 为系统的主要组件计算预留空间：应用服务器群组、网络设备、带宽、数据库服务器
- 建议任何组件的最大容量不要超过50%，特殊情况特殊对待

## 架构原则
- 根据公司的目标制定架构原则，应该和公司发展的使命和愿景相符
- 原则应该足够宽泛，避免不断修改，应该符合SMART原则
- 要跟团队一起来制定
- 制定过程要遵循RASCI
- 原则数量要控制好，确保容易记忆并增加利用率。建议不超过15个
    - N+1设计，冗余
    - 回滚设计，可回滚到以前任何版本
    - 禁用设计，能够关闭任何发布过的功能
    - 监控设计，在设计阶段就要考虑监控
    - 设计多活数据中心
    - 使用成熟的技术
    - 异步设计
    - 无状态设计
    - 水平扩展非垂直升级
    - 设计至少要有两个步骤的前瞻性，在扩展问题发生前考虑好下一步的行动计划
    - 非核心则购买，如果不是你擅长的，也提供不了差异化的竞争优势直接购买
    - 小构建、小发布、快速试错
    - 故障隔离
    - 自动化，机器能做就不要依赖人

## 联合架构设计（JAD）和架构审查委员会（ARB）
- 闭门造车带来的问题，最好是由跨部门并能提供不同观点的组进行设计
- JAD是集中跨部门团队成员能力的最好方法
- JAD的成员来自工程、架构和运维(数据库管理员、系统管理员、网络工程师)
- JAD成功的关键在于过程的完整性，严格坚持准入和批准的标准
- ARB可以看做是终审
- ARB成员的特质是：尊重、领导力和专业知识，可以轮换
- 进入ARB的项目应该是有充分的准备而且有一些具体问题，如：不符合架构原则、不能达成设计共识、重要的权衡、高风险性

## 敏捷架构设计
- 敏捷团队应该自主行动，这意味着他们应该用友自己的服务和产品设计
- ARB和JAD确保跨团队的服务设计。敏捷团队通过自身的构成确保这个结果
- 当资源有限（运维、架构师）的时候，把他们分配给多个团队，而不是排队等候。
- 跨团队共享标准和知识，以实现规模经济，敏捷团队有一些做法（Spotify的章节、工会。Wooga各种论坛分享）

## 自建与外钩
- 自建和外钩选择不对时，可能会破坏有效扩展的能力，并损坏股东价值
- 以成本为中心的决策方法重点是降低成本，但因为不聚焦，使其失去战略机会
- 以战略为中心的决策方法的重点是对标公司的长期需求，但不考虑总成本
- 把两个方法合并形成四部分的测试方法。好的决策，回答四个问题：
    - 自建组件能否形成具有战略性差异化的竞争优势？
    - 我们是该组件最好的拥有者吗？
    - 该组件的竞争情况如何？
    - 自建的成本效益如何？

## 确定风险
- 风险评估：知觉发，交通灯法，故障模式及影响分析法（FMEA）
- 风险管理：管理急性风险和管理整体风险，预定义每个行动或者每个时间段可以容忍的风险量

## 性能与压力测试
- 性能测试的目标是识别、记录和消除系统中的瓶颈
- 负载测试是性能测试中的一个过程，目的是验证应用能够满足预期的性能目标
- 性能测试的七个步骤：确定应用的标准-建立适当的测试环境-选择合适的测试服务-执行测试-分析数据-向工程师报告-重复测试和分析
- 压力测试是一个试图确定应用在高于正常负载的情况下稳定性的过程
- 压力测试八个步骤：确定测试的目标-选择要测试的关键服务-确定需要产生多少负载-建立适当的测试环境-确定必须的监视点-产生实际的测试负载-执行测试-分析数据

## 障碍条件与回滚
- 障碍条件用在开发生命周期早起隔离故障。例如：ARB设计审查、代码审查、性能测试、对生产环境的度量
- 要能回滚，设计禁用作为回滚的补充服务降级功能

# 可扩展的架构方案
## 故障隔离架构
- 泳道是故障隔离的架构，泳道里的事故不向外传播，所以不会影响平台的其他功能
- 豌豆荚（Pod）、碎片（Shard）和块（Chunk）是泳道的常用术语，但他们可能不是全系统的功能和故障隔离
- 故障隔离提高了可用性和扩展性，同时减少了上市时间和研发成本
- 故障隔离设计原则：绝不共享（共享越少越好），不跨越泳道，交易发生在泳道

## AKF扩展立方体
- X轴代表实体或者数据的克隆和他们之间毫无差异的工作分配，X轴往往是最不昂贵的实施，但受指令多少和数据大小的约束
- Y轴代表基于活动或者数据分割工作，Y轴往往比X轴更昂贵，除了构建隔离故障外，还可以解决与指令和数据大小相关的问题
- Z轴代表基于请求者或完成工作的人员来分割工作，Z轴是最贵的实施，但经常可以带来最大的扩展性

## AFK应用扩展
- X轴把相同的工作或应用的镜像分配给多个实体。可以理解为单应用做集群
- Y轴把工作职责基于动词或动作分割并分配到多个实体。可以理解为服务化，按功能模块拆分
- Z轴按照客户、客户需求、位置或者价值分割和分配工作。可以理解为异地多活，或者多租户的体系

## AFK数据库扩展
- X轴表示把相同的数据或镜像分散再多个实体。比如数据库主从，副本集等
- Y轴表示基于服务、资源或者数据关系的意义分离和分散数据。比如按模块分库，交易库、支付库
- Z轴表示基于查询按属性分割和分布数据。比如按月分表，按用户id，商品id分表

## 为扩展而缓存
- 处理大流量最好的方法是通过缓存来避免他
- 层层缓存：DNS缓存、CDN、CPU缓存、浏览器缓存。对象缓存、应用缓存、内容交付网络缓存

## 为扩展而异步
- 多任务时，可以同步可以异步，同步更简单
- 有状态和无状态，状态机，用户会话是有状态的，http是无状态协议
- 在同步和异步以及有状态和无状态之间明智选择方法是应用可扩展的关键

# 其他问题和挑战
## 海量数据
- 数据是昂贵的
- 大多数公司数据价值会随着时间推移而降低
- 考虑数据价值和时间期限做出正确的决定
- 大数据，分布式计算，MapReduce，Nosql

## 云计算
- 云计算的优势包括成本、速度和灵活性
- 云计算的劣势包括安全性、可控性、可移植性、性能和成本
- 有许多利用云环境的方式，按需决策，可以结合使用，作为超负荷容灾使用等

## 应用监控
- 把“设计能够监控的系统”作为架构原则
- 设计监控系统时，依次回答“出问题了吗”，“哪里出了问题”，“是什么问题”，逐步监控

## 规划数据中心
- 数据中心选址考虑因素：电力的成本、质量和可用性、地域风险、有经验的劳动力资源、网络传输成本和质量、空调的效率。
- 应用以三位核心的三条魔法规则
    - 驱动成本的三个要素：服务器、电力、空调
    - 任何服务都至少要三个服务器支持
    - 至少要设计三个数据服务中心提供服务
